{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Parking Predictions | ParkSpero Melbourne</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css">
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(to bottom, #6002ee 0%, #3a1397 60%, #102178 100%);
      min-height: 100vh;
      color: #452179;
    }
    .navbar {
      width: 100%;
      background: linear-gradient(90deg, #be7bf6 0%, #9400ff 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      padding: 0 32px;
      position: relative;
      min-height: 90px;
      box-sizing: border-box;
    }
    .navbar-content {
      width: 100%;
      max-width: 1500px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo-row { display: flex; align-items: center; gap: 18px; }
    .logo-row img {
      height: 106px; width: 106px; object-fit: contain;
      filter: drop-shadow(0 2px 10px #1d1a2e80);
    }
    .site-title {
      font-size: 1.8rem; font-weight: 900; color: #ffe441; letter-spacing: 1.5px;
      text-shadow: 0 2px 8px #32246888;
    }
    .marquee-bar {
      background: linear-gradient(90deg, #be7bf6cc 0%, #ffe441ee 85%);
      border-radius: 16px; min-width: 320px; max-width: 320px; height: 44px;
      margin: 0 18px; box-shadow: 0 2px 12px #963be333, 0 1px 8px #ffe44135;
      display: flex; align-items: center; overflow: hidden; padding: 0 20px; position: relative;
    }
    .marquee-text {
      display: flex; align-items: center; white-space: nowrap;
      font-weight: 900; color: #421d79; font-size: 1.09em;
      animation: marquee-move 12s linear infinite; letter-spacing: 0.5px;
      text-shadow: 0 1px 6px #fff8, 0 1px 3px #be7bf6cc;
    }
    .marquee-car-img {
      vertical-align: middle; display: inline-block; height: 22px; margin-right: 12px; margin-bottom: 2px;
      filter: drop-shadow(0 2px 8px #ffe44190);
    }
    @keyframes marquee-move { 0% { transform: translateX(50%);} 100% { transform: translateX(-100%);} }
    .nav-links { display: flex; align-items: center; gap: 5px; font-weight: 700; font-size: 0.8rem; }
    .nav-link {
      color: #ffffff; text-decoration: none; display: flex; align-items: center; gap: 5px;
      transition: opacity 0.15s; opacity: 0.93; font-size: 1.18em; font-weight: 900;
      padding: 0.22em 0.86em; border-radius: 10px; position: relative; cursor: pointer;
    }
    .nav-link:hover, .nav-link:focus-visible {
      color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8;
      outline: none; opacity: 1; background: none; box-shadow: none;
    }
    .nav-link.active { color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8; }

    /* Container */
    .container { max-width: 1100px; margin: 32px auto 48px auto; padding: 0 18px; }

    /* Header row with updated time */
    .page-header {
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px;
    }
    .page-title { color: #ffe441; font-size: 2rem; font-weight: 900; letter-spacing: .5px; }
    .updated-badge {
      background: #ffffff26; border: 1px solid #ffffff44; color: #fff; padding: 10px 14px; border-radius: 12px;
      font-weight: 800; font-size: .98rem; backdrop-filter: blur(2px);
    }
    .updated-badge.stale { background: #ffb3b326; border-color: #ffb3b380; color: #fff2f2; }

    /* Chips grid */
    .chips {
      display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 22px;
    }
    .chip {
      background: #faf5ff; border: 1.7px solid #d1a7ff30; border-radius: 14px;
      padding: 14px 12px; box-shadow: 0 3px 20px #c8b4ff22;
      display: flex; flex-direction: column; gap: 6px; min-height: 88px;
    }
    .chip .label { font-size: .9rem; font-weight: 900; color: #702ccf; letter-spacing: .3px; }
    .chip .count { font-size: 1.8rem; font-weight: 900; }
    .chip.green .count { color: #13ad48; }
    .chip.orange .count { color: #ff7b00; }
    .chip.amber .count { color: #e4a300; }
    .chip.yellow .count { color: #d9bf00; }
    .chip.blue .count { color: #3a66c7; }
    .chip.purple .count { color: #7a3df0; }

    /* Table */
    .card {
      border-radius: 16px; box-shadow: 0 3px 20px #c8b4ff22; margin-bottom: 22px;
      padding: 1.5em 1.4em 1.2em 1.4em; background: #faf5ff; border: 1.7px solid #d1a7ff30;
    }
    .card-title { color: #702ccf; font-size: 1.2em; font-weight: 900; margin-bottom: 10px; }
    table {
      width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden;
      border: 1.6px solid #eee7ff; box-shadow: 0 3px 15px #1c00631a;
    }
    thead th {
      text-align: left; background: #f4f0ff; color: #5323a4; padding: 12px 10px; font-weight: 900; font-size: .95rem;
      border-bottom: 1px solid #eae1ff;
    }
    tbody td {
      padding: 11px 10px; border-bottom: 1px solid #f1ebff; color: #35155e; font-weight: 700; font-size: .98rem;
    }
    tbody tr:hover { background: #faf7ff; }

    /* Badges */
    .badge {
      display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 900; font-size: .84rem;
      border: 1.5px solid transparent;
    }
    .b-unocc { background: #e9fff0; color: #119f41; border-color: #98f3b8; }
    .b-15m   { background: #fff1e6; color: #c55600; border-color: #ffcba3; }
    .b-30m   { background: #fffbe7; color: #c98e0f; border-color: #ffec98; }
    .b-60m   { background: #fffde9; color: #bb8b09; border-color: #ffe09d; }
    .b-gt60  { background: #f5faff; color: #3a66c7; border-color: #b7d5ff; }
    .b-perm  { background: #f2e9ff; color: #6d2ff0; border-color: #cdb3ff; }

    /* Loader mask */
    #loadingMask { opacity: 0; pointer-events: none; transition: opacity .22s; }
    #loadingMask.active { display: flex !important; opacity: 1; pointer-events: auto; }

    .golden-glow {
      color: #ffe441; font-weight: 900;
      text-shadow:
        -2px -2px 2px #222, 2px -2px 2px #222, -2px 2px 2px #222, 2px 2px 2px #222,
        -1px 0px 1px #222, 1px 0px 1px #222, 0px -1px 1px #222, 0px 1px 1px #222,
        0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8, 0 0 18px #ffe441b0;
    }
    @media (max-width: 1150px) { .chips { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 720px)  { .chips { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 520px)  { .chips { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-content">
      <div class="logo-row">
        <img src="{% static 'TA12_logo_V2-removebg-preview.png' %}" alt="Logo"/>
        <span class="site-title">ParkSpero Melbourne</span>
      </div>
      <div class="marquee-bar">
        <span class="marquee-text">
          <img class="marquee-car-img" src="{% static 'car-icon-gif-hd-png-download.png' %}" alt="car"/>
          G’day from ParkSpero Melbourne! TA12 brings you easier parking
        </span>
      </div>
      <div class="nav-links">
        <a class="nav-link" href="{% url 'home' %}"><i class="lucide lucide-home"></i>Home</a>
        <a class="nav-link" href="{% url 'live_parking' %}"><i class="lucide lucide-info"></i>Live Parking</a>
        <a class="nav-link active" href="{% url 'predictions' %}"><i class="lucide lucide-bar-chart-3"></i>Predictions</a>
        <a class="nav-link" href="{% url 'analytics' %}"><i class="lucide lucide-parking-circle"></i>Analytics</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <div class="page-title">Predictions</div>
      <div id="pred-updated" class="updated-badge">Updated —</div>
    </div>

    <!-- SIX CLASS CHIPS -->
    <div class="chips">
      <div class="chip green">
        <div class="label">Unoccupied</div>
        <div id="count-unoccupied" class="count">0</div>
      </div>
      <div class="chip orange">
        <div class="label">Vacate ≤ 15 min</div>
        <div id="count-vacate-15" class="count">0</div>
      </div>
      <div class="chip amber">
        <div class="label">Vacate ≤ 30 min</div>
        <div id="count-vacate-30" class="count">0</div>
      </div>
      <div class="chip yellow">
        <div class="label">Vacate ≤ 60 min</div>
        <div id="count-vacate-60" class="count">0</div>
      </div>
      <div class="chip blue">
        <div class="label">Occupied &gt; 60 min</div>
        <div id="count-gt60" class="count">0</div>
      </div>
      <div class="chip purple">
        <div class="label">Permit Parking</div>
        <div id="count-permit" class="count">0</div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <div class="card-title">Bay-level predictions (sorted by ETA)</div>
      <table id="pred-table">
        <thead>
          <tr>
            <th>Street</th>
            <th>Kerbside ID</th>
            <th>Status</th>
            <th>Classification</th>
            <th>ETA to Free</th>
            <th>Rule</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Inline JS for fetching predictions -->
  <script>
    (function () {
      const ENDPOINT = "/api/v1/predictions/";

      const countIds = {
        UNOCCUPIED: "count-unoccupied",
        VACATE_15M: "count-vacate-15",
        VACATE_30M: "count-vacate-30",
        VACATE_60M: "count-vacate-60",
        OCCUPIED_GT_60M: "count-gt60",
        PERMIT_PARKING: "count-permit",
      };

      let refreshTimer = null;

      function badgeFor(classification) {
        switch (classification) {
          case "UNOCCUPIED": return '<span class="badge b-unocc">Unoccupied</span>';
          case "VACATE_15M": return '<span class="badge b-15m">Vacate ≤ 15m</span>';
          case "VACATE_30M": return '<span class="badge b-30m">Vacate ≤ 30m</span>';
          case "VACATE_60M": return '<span class="badge b-60m">Vacate ≤ 60m</span>';
          case "OCCUPIED_GT_60M": return '<span class="badge b-gt60">> 60m</span>';
          case "PERMIT_PARKING": return '<span class="badge b-perm">Permit</span>';
          default: return classification || "";
        }
      }

      function humanETA(item) {
        if ((item.status || "").toLowerCase() === "unoccupied") return "—";
        if (item.allowed_minutes == null) return "> 60 min";
        const remaining = Math.max(0, Math.round(item.allowed_minutes - item.minutes_elapsed));
        return `${remaining} min`;
      }

      async function fetchPredictions() {
        const res = await fetch(ENDPOINT, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      }

      function setCounts(counts) {
        Object.entries(countIds).forEach(([key, id]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = counts?.[key] ?? 0;
        });
      }

      function setUpdated(genIso, ttl) {
        const el = document.getElementById("pred-updated");
        if (!el || !genIso) return;
        const gen = new Date(genIso);
        const now = new Date();
        const age = Math.max(0, Math.round((now - gen) / 1000));
        el.textContent = `Updated ${age}s ago`;
        el.classList.toggle("stale", ttl && age > ttl * 3);
      }

      function setTable(items) {
        const tbody = document.querySelector("#pred-table tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        // sort by ETA asc, unoccupied first
        items = Array.isArray(items) ? items.slice() : [];
        items.sort((a, b) => {
          const unoccA = a.classification === "UNOCCUPIED" ? 0 : 1;
          const unoccB = b.classification === "UNOCCUPIED" ? 0 : 1;
          if (unoccA !== unoccB) return unoccA - unoccB;
          const aEta = a.allowed_minutes == null ? 9999 : Math.max(0, a.allowed_minutes - a.minutes_elapsed);
          const bEta = b.allowed_minutes == null ? 9999 : Math.max(0, b.allowed_minutes - b.minutes_elapsed);
          return aEta - bEta;
        });

        // render up to 500 rows to keep DOM light
        items.slice(0, 500).forEach(it => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${it.street ?? ""}</td>
            <td>${it.kerbsideid ?? ""}</td>
            <td>${it.status ?? ""}</td>
            <td>${badgeFor(it.classification)}</td>
            <td>${humanETA(it)}</td>
            <td>${it.restriction_code ?? ""}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function scheduleNext(ttl) {
        if (refreshTimer) clearTimeout(refreshTimer);
        const wait = Math.max(10, (ttl || 60)) * 1000; // minimum 10s
        refreshTimer = setTimeout(refreshOnce, wait);
      }

      async function refreshOnce() {
        try {
          const data = await fetchPredictions();
          setCounts(data.counts || {});
          setTable(data.items || []);
          setUpdated(data.generated_at, data.ttl || 60);
          scheduleNext(data.ttl || 60);
        } catch (err) {
          console.error("Predictions fetch failed:", err);
          // retry later
          scheduleNext(30);
        }
      }

      document.addEventListener("DOMContentLoaded", refreshOnce);
    })();
  </script>

  <!-- Full Page Loading Mask (kept from your design) -->
  <div id="loadingMask"
       style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;
              background:rgba(32,18,77,0.16);backdrop-filter:blur(2.5px);
              align-items:center;justify-content:center;transition:opacity .22s;">
    <div style="background:#ffffff3c;border-radius:26px;padding:40px 60px;box-shadow:0 8px 28px #421d7999;
                display:flex;flex-direction:column;align-items:center;gap:16px;">
      <img src="{% static 'car_loading.gif' %}" alt="Loading..." style="width:450px;height:350px;display:block;">
      <span class="golden-glow" style="font-size:3em;letter-spacing:.8px;">Loading…</span>
    </div>
  </div>

  <script>
    function showLoadingMask() {
      const mask = document.getElementById('loadingMask');
      mask.style.display = 'flex';
      setTimeout(() => mask.classList.add('active'), 10);
    }
    function hideLoadingMask() {
      const mask = document.getElementById('loadingMask');
      mask.classList.remove('active');
      setTimeout(() => mask.style.display = 'none', 250);
    }
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        if (link.target === "_blank" || (link.href && !link.href.startsWith(window.location.origin))) return;
        e.preventDefault();
        showLoadingMask();
        setTimeout(() => { window.location.href = link.href; }, 600);
      });
    });
    window.onload = hideLoadingMask;
  </script>
</body>
</html>
